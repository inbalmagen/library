<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
</head>

<body>
    <h1>Loans</h1>
    <div id="Loans"></div>
    <a href="about.html">About</a><br>
    customer_id: <input id="customer_id"><br>
    book_id:<input id="book_id"><br>
    loan_date: <input id="loan_date"><br>
    return_date: <input id="return_date"><br>
    <button onclick="newLoan()">add new loan</button>
    <script>
        const MY_SERVER = 'http://127.0.0.1:5000';
        
        const newLoan = async () => {
            const customer_id = customer_id.value;
            const book_id = book_id.value;
            const loan_date = loan_date.value;
            const return_date = return_date.value;
            
            // Fetch the book details to determine the book type
            const bookResponse = await axios.get(`${MY_SERVER}/books/${book_id}`);
            const book = bookResponse.data;
            
            // Determine the maximum loan time based on the book type
            let maxLoanTime = 0;
            switch (book.type) {
                case 1:
                    maxLoanTime = 10;
                    break;
                case 2:
                    maxLoanTime = 5;
                    break;
                case 3:
                    maxLoanTime = 2;
                    break;
                default:
                    console.log('Invalid book type');
            }
            
            // Validate the loan duration
            const loanDuration = Math.ceil((new Date(return_date) - new Date(loan_date)) / (1000 * 60 * 60 * 24));
            if (loanDuration > maxLoanTime) {
                alert(`Loan duration exceeds the maximum allowed for this book type (${maxLoanTime} days).`);
                return;
            }
            
            const data = {
                customer_id: customer_id,
                book_id: book_id,
                loan_date: loan_date,
                return_date: return_date
            };
            
            const response = await axios.post(`${MY_SERVER}/loans`, data);
            loadData();
        };
        
        const delLoans = async (id) => {
            loans1 = await axios.delete(MY_SERVER + `/loans/${id}`);
            await loadData();
        };
        
        const updLoans = async (id) => {
            console.log(id);
            data = {
                customer_id: customer_id.value,
                book_id: book_id.value,
                loan_date: loan_date.value,
                return_date: return_date.value
            };
            
            loans1 = await axios.put(MY_SERVER + `/loans/${id}`, data);
            loadData();
        };
        
        const loadData = async () => {
            loans1 = await axios.get(MY_SERVER + `/loans`);
            console.log(loans1.data);
            Loans.innerHTML = loans1.data.map(
                loan => `<div>
                    <button onClick='delLoans(${loan.id})'>del ${loan.id}</button>
                    <button onClick='updLoans(${loan.id})'>update ${loan.id}</button>
                    ${loan.id} - ${loan.customer_id} - ${loan.book_id} - ${loan.loan_date} - ${loan.return_date}
                </div>`
            ).join('');
        };
        
        window.onload = loadData;
    </script>
</body>

</html>
